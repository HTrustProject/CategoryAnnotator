<html>
	<head>
	<link rel="stylesheet/less" type="text/css" href="css/styles.less" />
	<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>

	<!--
	The jQuery selectionPlugin is copied from the JavaSriptMVC Project
	[http://javascriptmvc.com/]. It's an easy way to get/set the boundaries
	as indexies of selected text. It works with all elements, also 
	across multiple elements. Now every jQuery object has th additionally
	function .selection() and .selection(start, end). To get the selection
	function running, it depends on range.js and compare.js.
	-->
	<script type="text/javascript" src="js/selectionPlugin/selection.js"></script>
	<script type="text/javascript" src="js/selectionPlugin/range.js"></script>
	<script type="text/javascript" src="js/selectionPlugin/compare.js"></script>
	
	<!--
	The jQuery wrapSelection Plugin [http://archive.plugins.jquery.com/project/wrapSelection]
	makes it possible to easily wrap an span element around an selected
	text. It also works with selections, which are spread across multiple
	elements, so it's generating the affordable amount of span tags,
	which can be styled with CSS. To avoid conflicts betweet the two
	plugins the Range in wrapSelection is now calles WSrange.
	-->
	<script type="text/javascript" src="js/wrapSelectionPlugin/jquery.wrapSelection.js"></script>
	
	<!--
	Less ads dynamic behaviour to CSS, to use variables, mixins, operations
	and functions.
	-->
	<script type="text/javascript" src="js/less-1.2.1.min.js"></script>
	
	
	<script type='text/javascript'>
		
		var atomList = [];
		var columnBars = [];
		
		$(document).ready(function(){
		
			
		
			$("#textFrame").mouseup(function(){
				addAtom($(this));
			});	
		});	
		
		function render(){
			
			// before the bars are rendered, the old ones have to be removed
			$(".special").remove();
			columnBars = [];
			
			// iterate all atoms and display them as bars
			for(atom in atomList){
				
				console.log("\n");
				console.log("render", atom);
				
				// remember the original content of the textFrame for late on
				var originalTextFrame = $("#textFrame").clone();
				
				var selectedAtom = $("#textFrame").selection(atomList[atom]["start"], atomList[atom]["end"]);
				
			
				// add span to selected text
				var span = $("#textFrame").wrapSelection();
				
				var page = $("#textFrame");
				var content = $("#content");
				
				var id = span.attr("class");
			
				// add div (vertical bar) -> styled later on
				$("body").append('<div class="special" id="special_'+id+'">&nbsp;</div>');
			
				// position for calculation
				var page_top = page.position().top;
				var page_left = page.position().left;
				var page_height = page.height() - page.css("margin-top");
				
				var content_top = content.position().top;
				var content_left = content.position().left;
				var content_height = content.height() - content.css("margin-top");
				
				var bar_top = span.position().top;
				var bar_left = content_left;
				var bar_height = span.height();
			
			
				// differet calcualtion if selection was across multiple elements
				if (span.length > 1){
					var lastSpan = span.last();
					var lastSpan_top = lastSpan.position().top;
					var lastSpan_height = lastSpan.height();
					bar_height = lastSpan_top - bar_top + lastSpan_height;
				}
				
				// change the style of the added bar	
				// TODO: bar_left needs to be calculated in the right way
				
				var left = findColumn(bar_top, bar_height);
				console.log("spalte", left);
				console.log("alleSpalten", columnBars);
				
				var offset = left * 5 + (left+1)* 10; 
						
				$("#special_"+id).css({"top":(content_top-470+(page_top-300)+bar_top+1), "left":bar_left - 350 - offset, "height":bar_height});
				
				// remove the span
				page.innerHTML = originalTextFrame.innerHTML;
			}
		}
		
		function findColumn(top, height){
			
			// if it is the first one
			if (columnBars.length == 0){
				columnBars.push([{"top":top, "height":height}]);
				return 0;
			}
			else {
			
				for(column in columnBars){
				
					if(fitsInColumn(top, height, column) == true){
						columnBars[column].push({"top":top, "height":height});
						return column;
					}
				}
				
				// open a new column
				columnBars.push([{"top":top, "height":height}]);
				return (columnBars.length - 1);
			}		
		}
		
		// use a sorted list to make the function more efficient
		function fitsInColumn(top, height, column){
			var column = columnBars[column];
			
			for (x in column){
				var bar = column[x];
				
				if (((top >= bar["top"]) && (top <= bar["top"]+bar["height"])) || ((top+height <= bar["top"]+bar["height"]) && (top+height >= bar["top"]))){
					return false;
				}
				else {
					return true;
				}
			}
			
			console.log("columnFits", column);
			return false;			
		}
		
		function addAtom(element){
			
			var selectedText = element.selection();
			
			// add new atom to the atomList
			atomList.push({"start":selectedText.start, "end":selectedText.end, "category": 1, "subcategory": 1});
			
			// render all bars again
			render();		
		};
			

	
	</script>
	
	
	</head>
	<body>
		<div id="content">
			<div id="menu">
				<div class="category">
					<h4>Kategory A</h4>
				</div>
				<div class="category">
					<h4>Kategory B</h4>
				</div>
				<div class="category">
					<h4>Kategory C</h4>
				</div>
			</div>

			<div id="textFrame">
				<p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.<br />At vero eos et accusam et justo duo dolores et ea rebum.</p><p>Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna liquyam erat, sed diam voluptua.</p><p>At vero eos et accusam et justo duo dolores et ea rebum.</p><p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et.</p>	
			</div>
		</div>
	</body>	
</html>

